name: Build and Deploy App03

on:
  push:
    branches:
      - main
      - STAGING
    paths:
      - 'services/app03/**'
      - 'shared/**'
      - '.github/workflows/deploy-app03.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PowerShell modules
        run: |
          pwsh -Command '
            $errors = @()
            try {
              Import-Module ./shared/modules/CWMShared.psm1 -Force
              $requiredFunctions = @("New-CWMLog", "Initialize-CWMApp")
              foreach ($func in $requiredFunctions) {
                if (-not (Get-Command $func -ErrorAction SilentlyContinue)) {
                  $errors += "Function $func not found"
                }
              }
              Write-Host "Module validation: OK"
            } catch {
              $errors += "Failed to import module: $_"
            }
            if ($errors) {
              $errors | ForEach-Object { Write-Host "ERROR: $_" }
              exit 1
            }
          '

      - name: Check app03 script syntax
        run: |
          pwsh -Command '
            $script = "./services/app03/appTimeSinceLastTimeEntry.ps1"
            try {
              [System.Management.Automation.PSParser]::Tokenize((Get-Content $script), [ref]$null) | Out-Null
              Write-Host "Script syntax: OK - $script"
            } catch {
              Write-Host "Syntax error in $script : $_"
              exit 1
            }
          '

      - name: Validate required files
        run: |
          pwsh -Command '
            $required = @(
              "services/app03/Dockerfile",
              "services/app03/appTimeSinceLastTimeEntry.ps1",
              "shared/modules/CWMShared.psm1"
            )
            $missing = @()
            foreach ($file in $required) {
              if (-not (Test-Path $file)) {
                $missing += $file
              }
            }
            if ($missing) {
              $missing | ForEach-Object { Write-Host "Missing: $_" }
              exit 1
            }
            Write-Host "Required files: OK"
          '

      - name: Verify required environment variables in deployment
        run: |
          pwsh -Command '
            $deploymentFile = "./.github/workflows/deploy-app03.yml"
            $requiredVars = @("CWM_CLIENTID", "CWM_COMPANY", "CWM_PRIVATEKEY", "CWM_PUBLICKEY", "CWM_SERVER")
            $content = Get-Content $deploymentFile -Raw
            $missing = @()
            foreach ($var in $requiredVars) {
              if ($content -notmatch "name: $var") {
                $missing += $var
              }
            }
            if ($missing) {
              Write-Host "ERROR: Missing environment variable definitions:"
              $missing | ForEach-Object { Write-Host "  - $_" }
              exit 1
            }
            Write-Host "Environment variables: OK - All required variables defined in deployment"
          '

      - name: Test shared storage mount path handling
        run: |
          docker build -f ./services/app03/Dockerfile -t cwm-app03:test .
          # Create a test mount point and run container with it mounted
          mkdir -p /tmp/cwm-test-mount
          CONTAINER_ID=$(docker run -d --rm -v /tmp/cwm-test-mount:/mnt/cwm-data cwm-app03:test pwsh -Command 'Start-Sleep -Seconds 3')
          sleep 4
          LOGS=$(docker logs $CONTAINER_ID 2>&1)
          echo "$LOGS"
          # Verify that the data path was created
          if [ -d "/tmp/cwm-test-mount/app03" ]; then
            echo "Shared storage: OK - Data directory created successfully"
            docker stop $CONTAINER_ID 2>/dev/null || true
          else
            echo "ERROR: Data directory not created at /mnt/cwm-data/app03"
            echo "Container logs:"
            echo "$LOGS"
            docker stop $CONTAINER_ID 2>/dev/null || true
            rm -rf /tmp/cwm-test-mount
            exit 1
          fi
          rm -rf /tmp/cwm-test-mount

      - name: Test container startup
        run: |
          docker build -f ./services/app03/Dockerfile -t cwm-app03:test .
          CONTAINER_ID=$(docker run -d --rm cwm-app03:test pwsh -Command 'Start-Sleep -Seconds 3')
          sleep 4
          LOGS=$(docker logs $CONTAINER_ID 2>&1)
          echo "$LOGS"
          if echo "$LOGS" | grep -q "Initializing app"; then
            echo "Container startup: OK"
            docker stop $CONTAINER_ID 2>/dev/null || true
          else
            echo "ERROR: Container did not start properly"
            docker stop $CONTAINER_ID 2>/dev/null || true
            exit 1
          fi

  build:
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build app03 image
        id: docker_build_app03
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/app03/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/cwm-app03:${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}
            ${{ secrets.ACR_LOGIN_SERVER }}/cwm-app03:${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}-${{ github.sha }}

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy App03 to Azure Container Instances
        run: |
          # Create a temporary deployment file with substituted values
          CONTAINER_GROUP_NAME=${{ github.ref == 'refs/heads/main' && 'cwm-prod-app03' || 'cwm-staging-app03' }}
          IMAGE_TAG=${{ github.ref == 'refs/heads/main' && 'prod' || 'staging' }}-${{ github.sha }}
          SHARE_NAME=${{ github.ref == 'refs/heads/main' && 'cwm-prod-shared-data' || 'cwm-staging-shared-data' }}
          
          cat > /tmp/aci-app03-deployment.yaml << EOF
          apiVersion: '2021-09-01'
          location: ${{ secrets.AZURE_LOCATION }}
          name: $CONTAINER_GROUP_NAME
          properties:
            volumes:
            - name: cwm-shared-data
              azureFile:
                shareName: $SHARE_NAME
                storageAccountName: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
                storageAccountKey: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
            containers:
            - name: app03
              properties:
                image: ${{ secrets.ACR_LOGIN_SERVER }}/cwm-app03:$IMAGE_TAG
                resources:
                  requests:
                    cpu: 0.5
                    memoryInGb: 0.5
                environmentVariables:
                  - name: SERVICE_NAME
                    value: app03
                  - name: LOG_LEVEL
                    value: Info
                  - name: CWM_ClientID
                    value: ${{ secrets.CWM_CLIENTID }}
                  - name: CWM_Company
                    value: ${{ secrets.CWM_COMPANY }}
                  - name: CWM_PrivateKey
                    value: ${{ secrets.CWM_PRIVATEKEY }}
                  - name: CWM_PublicKey
                    value: ${{ secrets.CWM_PUBLICKEY }}
                  - name: CWM_Server
                    value: ${{ secrets.CWM_SERVER }}
                volumeMounts:
                  - name: cwm-shared-data
                    mountPath: /mnt/cwm-data
            osType: Linux
            imageRegistryCredentials:
            - server: ${{ secrets.ACR_LOGIN_SERVER }}
              username: ${{ secrets.ACR_USERNAME }}
              password: ${{ secrets.ACR_PASSWORD }}
            restartPolicy: Always
          EOF
          
          # Delete existing container group if it exists
          az container delete \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name $CONTAINER_GROUP_NAME \
            --yes 2>/dev/null || true
          
          # Create the container group from the deployment file
          az container create \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --file /tmp/aci-app03-deployment.yaml
